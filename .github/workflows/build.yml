name: Build and deploy config

on:
    pull_request:
    workflow_dispatch:
    workflow_call:
        secrets:
            GH_TOKEN:
                required: true

jobs:
    build-server-config:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        outputs:
            nix_store_path: ${{ steps.build.outputs.nix_store_path }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install Nix
              uses: DeterminateSystems/nix-installer-action@main
              with:
                  extra-conf: |
                      access-tokens = github.com=${{ secrets.GH_TOKEN }}

            - uses: DeterminateSystems/magic-nix-cache-action@main
              name: Set up nix cache

            - name: Build config
              id: build
              run: |
                  outpath=$(nix build .#vidar --no-link --json | jq -r '.[].outputs.out')
                  echo "::debug::Derivation output path: ${outpath}"
                  echo "nix_store_path=${outpath}" >> "$GITHUB_OUTPUT"

    deploy-server-config:
        runs-on: ubuntu-latest
        needs: build-server-config
        permissions:
          contents: read
          id-token: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install Nix
              uses: DeterminateSystems/nix-installer-action@main
              with:
                  extra-conf: |
                      access-tokens = github.com=${{ secrets.GH_TOKEN }}

            - uses: DeterminateSystems/magic-nix-cache-action@main
              name: Set up nix cache

            - uses: webfactory/ssh-agent@v0.9.1
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add server to authorized keys
              run: |
                  ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

            - name: Copy config to server
              run: |
                  nix copy .#vidar --to ssh://${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}

            - name: Apply config
              run: |
                  ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "sudo ${NIX_STORE_PATH}/bin/switch-to-configuration switch"
              env:
                  NIX_STORE_PATH: ${{ needs.build-server-config.outputs.nix_store_path }}
